import{u as Z,v as ee,r as f,s as te,w as F,j as e,M as _,aG as se,aJ as re,aK as ae}from"./react-vendor--vquuSlV.js";import{u as ne,h as oe,g as M,C as A,a as K,b as ie,c as ce,L as O,i as le,j as de,B as I,I as me,l as ue,p as fe}from"./index-CWe1EfRc.js";const be=({groupId:n,groupTitle:G,showEditToggle:he=!1,compact:D=!1})=>{const{t:o}=Z(),{user:d}=ne(),{toast:j}=oe(),m=ee(),[b,E]=f.useState(""),[N,z]=f.useState(null),[g,p]=f.useState(!1),[W,B]=f.useState(!0),v=f.useRef(null),J=f.useRef(null),l=n?String(n):"",{data:T,isLoading:L}=te({queryKey:["chat",l,"messages"],queryFn:async()=>(await M.get(`/chat/${n}/messages`)).data.data.messages||[],enabled:!!n,refetchOnWindowFocus:!1,refetchInterval:g?!1:3e3,onSuccess:()=>{m.invalidateQueries({queryKey:["chat","unread-counts"]})}}),y=F({mutationFn:async t=>{if(!n)throw new Error("Group ID is required");return(await M.post(`/chat/${n}/messages`,{content:t})).data},onMutate:async t=>{const s=`temp-${Date.now()}`,r={_id:s,content:t,createdAt:new Date().toISOString(),senderId:d,sender:d};return m.setQueryData(["chat",l,"messages"],a=>[...a||[],r]),setTimeout(()=>v.current?.scrollIntoView({behavior:"smooth"}),50),{tempId:s}},onSuccess:(t,s,r)=>{const a=t?.data?.message||t?.message;a&&r?.tempId&&l?m.setQueryData(["chat",l,"messages"],c=>c?c.map(h=>h._id===r.tempId?a:h).filter((h,U,C)=>C.findIndex(u=>u._id===h._id)===U):[a]):l&&m.invalidateQueries({queryKey:["chat",l,"messages"]})},onError:(t,s,r)=>{r?.tempId&&l&&m.setQueryData(["chat",l,"messages"],a=>a?a.filter(c=>c._id!==r.tempId):[]),j({variant:"destructive",title:o("common.error"),description:t.response?.data?.message||o("chat.sendFailed")})}}),Q=F({mutationFn:async t=>(await M.delete(`/chat/messages/${t}`)).data,onSuccess:()=>{l&&m.invalidateQueries({queryKey:["chat",l,"messages"]})},onError:t=>{j({variant:"destructive",title:o("common.error"),description:t.response?.data?.message||o("chat.deleteFailed")})}});f.useEffect(()=>{if(!n||!d?._id){p(!1);return}let t=null,s=null,r=0;const a=5,c=()=>{try{const w=localStorage.getItem("token"),h=ue(),C=`${h.endsWith("/api/chat/ws")?h:`${h.replace(/\/+$/,"")}/api/chat/ws`}?groupId=${n}&userId=${encodeURIComponent(d._id)}${w?`&token=${encodeURIComponent(w)}`:""}`;t=new WebSocket(C),t.onopen=()=>{console.log("Chat WebSocket connected successfully"),p(!0),r=0},t.onmessage=u=>{try{const i=JSON.parse(u.data);if(i.type==="new_message"){const x=i.data;(x.senderId?._id?.toString()||x.senderId?.toString()||x.sender?.toString())===d?._id?.toString()||fe();const Y=["chat",String(n),"messages"];m.setQueryData(Y,S=>S?S.some(X=>X._id===x._id)?S:[...S,x]:[x]),R()}else if(i.type==="message_deleted"){const x=["chat",String(n),"messages"];m.setQueryData(x,$=>$?$.filter(q=>q._id!==i.data.messageId):[])}else i.type==="connected"?(console.log("Chat connected:",i.message),p(!0)):i.type==="pong"&&console.log("WebSocket pong received")}catch(i){console.error("Error parsing WebSocket message:",i)}},t.onerror=u=>{console.error("WebSocket error:",u),p(!1),r===0&&console.warn("WebSocket connection failed, will retry silently")},t.onclose=u=>{if(console.log("Chat WebSocket disconnected",u.code,u.reason),p(!1),u.code!==1e3&&r<a&&n&&d?._id){r++;const i=Math.min(1e3*Math.pow(2,r),1e4);console.log(`Reconnecting in ${i}ms (attempt ${r}/${a})...`),s=setTimeout(()=>{c()},i)}else r>=a&&(console.warn("WebSocket reconnection limit reached; chat still works via HTTP."),j({title:o("chat.connectionError"),description:o("chat.connectionErrorDesc")}))},z(t)}catch(w){console.error("Error creating WebSocket:",w),p(!1)}};return c(),()=>{s&&clearTimeout(s),t&&t.close()}},[n,d?._id,m,j]),f.useEffect(()=>{if(!N||!g)return;const t=setInterval(()=>{N.readyState===WebSocket.OPEN&&N.send(JSON.stringify({type:"ping"}))},3e4);return()=>clearInterval(t)},[N,g]),f.useEffect(()=>{R()},[T]);const R=()=>{v.current?.scrollIntoView({behavior:"smooth"})},P=t=>{if(t.preventDefault(),!b.trim()||y.isLoading)return;const s=b.trim();E(""),y.mutate(s)},H=t=>{window.confirm("Are you sure you want to delete this message?")&&Q.mutate(t)},V=t=>{const s=new Date(t),r=new Date,a=r-s,c=Math.floor(a/6e4);return c<1?"Just now":c<60?`${c}m ago`:s.toDateString()===r.toDateString()?s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})},k=T||[];return n?e.jsxs(A,{className:`border-2 border-border/50 shadow-lg flex flex-col ${D?"min-h-0 flex-1 border-0 shadow-none":"h-[600px]"}`,children:[!D&&e.jsx(ie,{className:"pb-3 border-b border-border/50 bg-gradient-to-r from-primary/5 to-background",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(_,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsxs(ce,{className:"text-lg",children:[G," Chat"]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${g?"bg-green-500":"bg-red-500"}`}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g?"Connected":"Disconnected"})]})]})]})})}),e.jsxs(K,{className:"flex-1 flex flex-col p-0 overflow-hidden min-h-0",children:[e.jsxs("div",{ref:J,className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gradient-to-b from-background to-muted/20 min-h-0",children:[L&&k.length===0?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(O,{size:"md"}),e.jsx("span",{className:"ml-2 text-sm text-muted-foreground",children:o("common.loading")})]}):null,!L&&k.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-center text-muted-foreground",children:[e.jsx(_,{className:"h-16 w-16 mb-4 opacity-30"}),e.jsx("p",{className:"text-lg font-medium",children:"No messages yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Start the conversation!"})]}):k.map(t=>{const s=t.senderId||t.sender,r=s?._id?.toString()===d?._id?.toString()||s?.toString()===d?._id?.toString();return e.jsxs("div",{className:`flex gap-3 ${r?"flex-row-reverse":"flex-row"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-white font-semibold text-sm flex-shrink-0 ${de(s?.username||s?.email||"User")}`,children:le(s?.firstName&&s?.lastName?`${s.firstName} ${s.lastName}`:s?.username||s?.email||"U")}),e.jsxs("div",{className:`flex flex-col gap-1 max-w-[70%] ${r?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`flex items-center gap-2 ${r?"flex-row-reverse":"flex-row"}`,children:[e.jsx("span",{className:"text-xs font-medium text-foreground",children:r?"You":s?.firstName&&s?.lastName?`${s.firstName} ${s.lastName}`:s?.username||"Unknown"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:V(t.createdAt)})]}),e.jsxs("div",{className:`group relative px-4 py-2.5 rounded-2xl ${r?"bg-primary text-primary-foreground rounded-br-sm":"bg-card border border-border/50 rounded-bl-sm"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:t.content}),r&&!String(t._id).startsWith("temp-")&&e.jsx(I,{variant:"ghost",size:"sm",className:"absolute -right-2 -top-2 opacity-0 group-hover:opacity-100 transition-opacity h-6 w-6 p-0 rounded-full bg-background/80 hover:bg-destructive hover:text-destructive-foreground",onClick:()=>H(t._id),disabled:Q.isLoading,children:e.jsx(se,{className:"h-3 w-3"})})]})]})]},t._id)}),e.jsx("div",{ref:v})]}),W&&e.jsxs("form",{onSubmit:P,className:"p-4 border-t border-border/50 bg-background",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(me,{value:b,onChange:t=>E(t.target.value),placeholder:o("chat.typeMessage"),className:"flex-1 rounded-full border-2 focus:border-primary",maxLength:2e3,disabled:y.isLoading}),e.jsx(I,{type:"submit",disabled:!b.trim()||y.isLoading,className:"rounded-full px-6 bg-primary hover:bg-primary/90 disabled:opacity-50",children:y.isLoading?e.jsx(O,{size:"sm"}):e.jsx(re,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:o("chat.charactersCount",{count:b.length})}),!g&&e.jsxs("p",{className:"text-xs text-amber-600 dark:text-amber-400 flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-amber-500 animate-pulse"}),o("chat.reconnecting")]})]})]}),!W&&e.jsxs("div",{className:"p-4 border-t border-border/50 bg-muted/30 text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:o("chat.clickEditToSend")}),e.jsxs(I,{variant:"outline",size:"sm",onClick:()=>B(!0),className:"rounded-full",children:[e.jsx(ae,{className:"h-4 w-4 me-2"}),o("chat.enableChat")]})]})]})]}):e.jsx(A,{className:"border-2 border-border/50 shadow-lg h-[600px] flex items-center justify-center",children:e.jsxs(K,{className:"text-center",children:[e.jsx(_,{className:"h-16 w-16 mx-auto mb-4 text-muted-foreground opacity-50"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a Group"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a group from the list to start chatting"})]})})};export{be as G};
