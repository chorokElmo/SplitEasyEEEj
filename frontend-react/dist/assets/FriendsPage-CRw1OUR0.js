import{u as ie,r as x,v as de,s as k,w as Q,j as e,U as L,aL as D,d as $,J as V,z as O,a0 as b,b as X,aM as Y,aG as G,aD as H,aN as le,X as oe}from"./react-vendor--vquuSlV.js";import{h as ce,g as m,L as R,C as I,a as C,B as u,b as _,c as T,d as U,I as me,i as S,j as E,f as J}from"./index-CWe1EfRc.js";const xe=()=>{const{t:r}=ie(),[o,F]=x.useState(""),[l,W]=x.useState("friends"),[N,v]=x.useState([]),[z,y]=x.useState(!1),[w,h]=x.useState(null),{toast:g}=ce(),p=de(),{data:f,isLoading:Z,error:P}=k({queryKey:["friends"],queryFn:async()=>{try{const s=await m.get("/friends/my");return Array.isArray(s.data)?s.data:s.data?.data||[]}catch(s){return console.error("Error fetching friends:",s),[]}},retry:1}),{data:q,isLoading:ee,error:K}=k({queryKey:["friend-requests-received"],queryFn:async()=>{try{const s=await m.get("/friends/requests/received");return Array.isArray(s.data)?s.data:s.data?.data||[]}catch(s){return console.error("Error fetching received requests:",s),[]}},retry:1}),{data:A,error:M}=k({queryKey:["friend-requests-sent"],queryFn:async()=>{try{const s=await m.get("/friends/requests/sent");return Array.isArray(s.data)?s.data:s.data?.data||[]}catch(s){return console.error("Error fetching sent requests:",s),[]}},retry:1}),se=Q({mutationFn:async s=>{if(!s||s.trim().length<2)throw new Error("Search query must be at least 2 characters");const t=await m.get(`/friends/search?query=${encodeURIComponent(s.trim())}`),n=t.data?.data||t.data,i=Array.isArray(n)?n:[];try{return i.filter(a=>a!=null).map(a=>{try{let d=a._id||a.id;return d!=null&&(typeof d=="object"&&d.toString?d=d.toString():typeof d!="string"&&(d=String(d))),{...a,_id:d,id:d}}catch(d){return console.warn("Error processing user:",a,d),null}}).filter(a=>{if(!a)return!1;const d=a._id||a.id;if(!d)return!1;const ae=typeof d=="string"?d:String(d);return/^[0-9a-fA-F]{24}$/.test(ae)})}catch(a){return console.error("Error processing search results:",a),[]}},onSuccess:s=>{v(Array.isArray(s)?s:[]),y(!1)},onError:s=>{const t=s.response?.data?.message||s.message||r("friends.searchFailed");g({variant:"destructive",title:r("friends.searchFailed"),description:t}),v([]),y(!1)}});x.useEffect(()=>{if(o.trim().length>=2){y(!0);const s=setTimeout(()=>{se.mutate(o.trim())},500);return()=>{clearTimeout(s),y(!1)}}else v([]),y(!1)},[o]);const j=s=>{if(!s)return console.warn("getValidId: item is null or undefined"),null;let t=s._id||s.id||s.friendship_id||s.requestId;if(t&&typeof t=="object")if(t.toString&&typeof t.toString=="function")t=t.toString();else if(t._id)t=t._id;else return console.warn("getValidId: ID is an object but cannot be converted:",t),null;return typeof t!="string"?(console.warn("getValidId: ID is not a string:",typeof t,t),null):(t=t.trim(),/^[0-9a-fA-F]{24}$/.test(t)?t:(console.warn("getValidId: ID does not match ObjectId format:",t,"Item:",s),null))},c=Q({mutationFn:async({type:s,id:t,item:n})=>{const i=t||j(n);if(!i)throw console.error("Invalid ID provided:",{type:s,id:t,item:n}),new Error("Invalid ID provided. Please try again.");if(!/^[0-9a-fA-F]{24}$/.test(i))throw console.error("ID does not match ObjectId format:",i),new Error("Invalid ID format. Please try again.");switch(console.log(`Sending ${s} request with ID:`,i),s){case"add":return m.post(`/friends/request/${i}`);case"accept":return m.post(`/friends/request/${i}/accept`);case"reject":return m.post(`/friends/request/${i}/reject`);case"cancel":return m.post(`/friends/request/${i}/cancel`);case"remove":return m.delete(`/friends/remove/${i}`);default:throw new Error("Unknown action")}},onSuccess:(s,t)=>{const n={add:r("friends.requestSent"),accept:r("friends.requestAccepted"),reject:r("friends.requestRejected"),cancel:r("friends.requestCancelled"),remove:r("friends.friendRemoved")};g({title:n[t.type]||r("common.success"),description:t.type==="add"?r("friends.willBeNotified"):""}),p.invalidateQueries({queryKey:["friends"]}),p.invalidateQueries({queryKey:["friend-requests-received"]}),p.invalidateQueries({queryKey:["friend-requests-sent"]}),h(null),t.type==="add"&&(v([]),F(""))},onError:s=>{let t=s.message||r("friends.actionFailed");s.response?.data&&(s.response.data.message?t=s.response.data.message:s.response.data.errors&&Array.isArray(s.response.data.errors)?t=s.response.data.errors.map(n=>n.message||n.field).join(", "):s.response.data.error&&(t=s.response.data.error)),s.response?.status===400&&(t.includes("ObjectId")||t.includes("pattern")?t=r("errors.invalidId")||"Invalid ID format. Please try again.":t.includes("already")||(t=t||r("errors.validationError")||"Validation error. Please check your input.")),g({variant:"destructive",title:s.response?.status===400?r("errors.validationError")||"Validation Error":r("friends.actionFailed"),description:t}),console.error("Friend action error:",{status:s.response?.status,message:t,data:s.response?.data}),s.response?.status!==400&&s.response?.status!==404&&h(null)}}),re=Z||ee,te=P||K||M;if(re)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(R,{size:"lg"})});const B=x.useMemo(()=>{try{if(!o||l!=="friends")return Array.isArray(f)?f:[];const s=o.toLowerCase();return(Array.isArray(f)?f:[]).filter(n=>n?n.username?.toLowerCase().includes(s)||n.email?.toLowerCase().includes(s)||n.firstName?.toLowerCase().includes(s)||n.lastName?.toLowerCase().includes(s):!1)}catch(s){return console.error("Error filtering friends:",s),[]}},[f,o,l]),ne=[{id:"friends",label:r("friends.friends"),count:f?.length||0,icon:L,color:"text-blue-600"},{id:"received",label:r("friends.requests"),count:q?.length||0,icon:D,color:"text-amber-600"},{id:"sent",label:r("friends.sent"),count:A?.length||0,icon:$,color:"text-purple-600"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:r("friends.title")}),e.jsx("p",{className:"text-muted-foreground mt-1",children:r("friends.subtitle")})]}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs("div",{className:"text-end",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:f?.length||0}),e.jsx("div",{className:"text-sm text-muted-foreground",children:r("friends.friendCount",{count:f?.length||0})})]})})]}),te&&e.jsx(I,{className:"border-red-200 bg-red-50",children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(V,{className:"h-5 w-5 text-red-600"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:r("errors.serverError")}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:P?.message||K?.message||M?.message||r("errors.unknownError")})]}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>{p.invalidateQueries({queryKey:["friends"]}),p.invalidateQueries({queryKey:["friend-requests-received"]}),p.invalidateQueries({queryKey:["friend-requests-sent"]})},children:r("common.retry")})]})})}),e.jsxs(I,{children:[e.jsxs(_,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(O,{className:"h-5 w-5 text-primary"}),r("friends.findFriends")]}),e.jsx(U,{children:r("friends.searchDescription")})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(O,{className:"absolute start-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(me,{placeholder:r("friends.searchPlaceholder"),value:o,onChange:s=>F(s.target.value),className:"ps-10 pe-10"}),z&&e.jsx("div",{className:"absolute end-3 top-1/2 transform -translate-y-1/2",children:e.jsx(R,{size:"sm"})})]}),N.length>0&&e.jsxs("div",{className:"space-y-3 mt-4 border-t pt-4",children:[e.jsxs("p",{className:"text-sm font-medium text-muted-foreground",children:[r("common.search")," Results (",N.length,")"]}),e.jsx("div",{className:"space-y-2",children:N.map((s,t)=>{if(!s)return null;const n=s._id||s.id||`user-${t}`;return e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-accent transition-colors group",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-14 h-14 rounded-full flex items-center justify-center text-white font-semibold text-lg ${E(s.username||s.email)}`,children:S(s.username||s.email)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-base",children:s.username}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(b,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email})]}),(s.firstName||s.lastName)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:[s.firstName,s.lastName].filter(Boolean).join(" ")})]})]}),e.jsxs(u,{size:"sm",onClick:()=>{console.log("Button clicked, user object:",s);const i=j(s);console.log("Extracted userId:",i),i?(console.log("Sending friend request with userId:",i),c.mutate({type:"add",id:i,item:s})):(console.error("Invalid user ID:",s),g({variant:"destructive",title:r("errors.validationError"),description:"Invalid user ID. Please try searching again."}))},disabled:c.isLoading,className:"opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(X,{className:"me-2 h-4 w-4"}),r("friends.sendRequest")]})]},n)})})]}),o.length>=2&&!z&&N.length===0&&e.jsxs("div",{className:"text-center py-8 border-t pt-4",children:[e.jsx(Y,{className:"h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50"}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-1",children:r("friends.noUsersFound",{term:o})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("friends.tryDifferentTerm")})]})]})]}),e.jsx("div",{className:"flex space-x-1 bg-muted p-1 rounded-lg",children:ne.map(s=>{const t=s.icon,n=l===s.id;return e.jsxs("button",{onClick:()=>{W(s.id),F(""),v([])},className:`flex-1 px-4 py-3 rounded-md text-sm font-medium transition-all flex items-center justify-center gap-2 ${n?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground hover:bg-background/50"}`,children:[e.jsx(t,{className:`h-4 w-4 ${n?s.color:""}`}),e.jsx("span",{children:s.label}),s.count>0&&e.jsx("span",{className:`px-2 py-0.5 rounded-full text-xs font-semibold ${n?"bg-primary/10 text-primary":"bg-muted-foreground/20 text-muted-foreground"}`,children:s.count})]},s.id)})}),e.jsxs(I,{children:[e.jsx(_,{children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[l==="friends"&&e.jsx(L,{className:"h-6 w-6 text-blue-600"}),l==="received"&&e.jsx(D,{className:"h-6 w-6 text-amber-600"}),l==="sent"&&e.jsx($,{className:"h-6 w-6 text-purple-600"}),e.jsxs("div",{children:[e.jsxs(T,{children:[l==="friends"&&r("friends.yourFriends"),l==="received"&&r("friends.friendRequests"),l==="sent"&&r("friends.sentRequests")]}),e.jsxs(U,{children:[l==="friends"&&r("friends.peopleYouCanSplit"),l==="received"&&r("friends.waitingForResponse"),l==="sent"&&r("friends.requestsYouSent")]})]})]})})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-3",children:[l==="friends"&&e.jsx(e.Fragment,{children:B.length>0?B.map((s,t)=>{const n=j(s);return n?e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-accent transition-colors group",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-14 h-14 rounded-full flex items-center justify-center text-white font-semibold text-lg ${E(s.username||s.email)}`,children:S(s.username||s.email)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-base",children:s.username}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(b,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email})]})]})]}),e.jsxs(u,{variant:"outline",size:"sm",className:"opacity-0 group-hover:opacity-100 transition-opacity",onClick:()=>{n?h(n):g({variant:"destructive",title:r("errors.validationError"),description:r("friends.invalidFriendId")})},children:[e.jsx(G,{className:"h-4 w-4 me-2 text-red-600"}),r("friends.remove")]})]},n||t):(console.warn("Invalid friend ID:",s),null)}).filter(Boolean):e.jsxs("div",{className:"text-center py-16",children:[e.jsx(L,{className:"h-20 w-20 text-muted-foreground mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:r(o?"friends.noFriendsMatch":"friends.noFriends")}),e.jsx("p",{className:"text-sm text-muted-foreground mb-6",children:r(o?"friends.tryDifferentTerm":"friends.startSearching")}),!o&&e.jsxs(u,{onClick:()=>{const s=document.querySelector('input[placeholder*="Search"]');s&&s.focus()},children:[e.jsx(X,{className:"me-2 h-4 w-4"}),r("friends.findFriends")]})]})}),l==="received"&&e.jsx(e.Fragment,{children:q?.length>0?q.map((s,t)=>{const n=s.username||s.sender?.username||s.userId?.username||"Unknown",i=s.email||s.user_email||s.sender?.email||s.userId?.email||"",a=j(s);return a?e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-accent transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-14 h-14 rounded-full flex items-center justify-center text-white font-semibold text-lg ${E(n)}`,children:S(n)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-base",children:n}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(b,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i})]}),s.created_at&&e.jsxs("div",{className:"flex items-center gap-1 mt-2",children:[e.jsx(H,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:J(s.created_at)})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(u,{size:"sm",onClick:()=>c.mutate({type:"accept",id:a,item:s}),disabled:c.isLoading,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(le,{className:"h-4 w-4 me-2"}),r("friends.accept")]}),e.jsx(u,{size:"sm",variant:"outline",onClick:()=>c.mutate({type:"reject",id:a,item:s}),disabled:c.isLoading,children:e.jsx(Y,{className:"h-4 w-4"})})]})]},a||t):(console.warn("Invalid request ID:",s),null)}).filter(Boolean):e.jsxs("div",{className:"text-center py-16",children:[e.jsx(D,{className:"h-20 w-20 text-muted-foreground mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:r("friends.noPendingRequests")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r("friends.allCaughtUp")})]})}),l==="sent"&&e.jsx(e.Fragment,{children:A?.length>0?A.map((s,t)=>{const n=s.username||s.receiver?.username||s.userId?.username||"Unknown",i=s.email||s.friend_email||s.receiver?.email||s.userId?.email||"",a=j(s);return a?e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg hover:bg-accent transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:`w-14 h-14 rounded-full flex items-center justify-center text-white font-semibold text-lg ${E(n)}`,children:S(n)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-base",children:n}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(b,{className:"h-3 w-3 text-muted-foreground"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i})]}),s.created_at&&e.jsxs("div",{className:"flex items-center gap-1 mt-2",children:[e.jsx(H,{className:"h-3 w-3 text-muted-foreground"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r("friends.sent")," ",J(s.created_at)]})]})]})]}),e.jsxs(u,{size:"sm",variant:"outline",onClick:()=>c.mutate({type:"cancel",id:a,item:s}),disabled:c.isLoading,children:[e.jsx(oe,{className:"h-4 w-4 me-2"}),r("friends.cancel")]})]},a||t):(console.warn("Invalid request ID:",s),null)}).filter(Boolean):e.jsxs("div",{className:"text-center py-16",children:[e.jsx($,{className:"h-20 w-20 text-muted-foreground mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:r("friends.noSentRequests")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r("friends.haventSent")})]})})]})})]}),w&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>h(null),children:e.jsxs(I,{className:"w-full max-w-md",onClick:s=>s.stopPropagation(),children:[e.jsxs(_,{children:[e.jsxs(T,{className:"flex items-center gap-2 text-red-600",children:[e.jsx(V,{className:"h-5 w-5"}),r("friends.removeFriend")]}),e.jsx(U,{children:r("friends.removeConfirm")})]}),e.jsxs(C,{className:"flex gap-3 justify-end pt-4",children:[e.jsx(u,{variant:"outline",onClick:()=>h(null),children:r("common.cancel")}),e.jsx(u,{variant:"destructive",onClick:()=>{w&&j({_id:w})?c.mutate({type:"remove",id:w}):(g({variant:"destructive",title:r("errors.validationError"),description:r("friends.invalidFriendId")}),h(null))},disabled:c.isLoading,children:c.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(R,{size:"sm",className:"me-2"}),r("friends.removing")]}):e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"h-4 w-4 me-2"}),r("friends.remove")]})})]})]})})]})};export{xe as default};
