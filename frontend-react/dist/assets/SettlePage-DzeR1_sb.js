import{u as X,r as u,v as pe,s as T,w as _,j as e,aO as he,aP as ge,a3 as V,U as Z,aQ as fe,Z as je,z as ye,aR as be,R as Ne}from"./react-vendor--vquuSlV.js";import{h as ve,u as we,g as j,L as J,B as P,C as w,b as A,c as F,a as S,d as W,I as ee,i as k,j as L,e as Se}from"./index-CWe1EfRc.js";import{D as Pe,a as Ce,b as Ie,c as Ae,d as Fe,e as De}from"./dialog-BKDal8hE.js";const g=s=>Se(s||0,"MAD");function Me({rawStatus:s,status:n}){const{t:x}=X(),m=s==="awaiting_confirmation"?x("settle.awaitingConfirmation","Awaiting Confirmation"):s==="pending"||n==="unpaid"?x("settle.pending","Pending"):s==="paid"||s==="accepted"?x("settle.paidDone","Paid ✓"):x("settle.partial","Partial"),C=s==="awaiting_confirmation"?"bg-amber-100 text-amber-800 border-amber-300":s==="pending"||n==="unpaid"?"bg-red-100 text-red-800 border-red-300":s==="paid"||s==="accepted"?"bg-green-100 text-green-800 border-green-300":"bg-slate-100 text-slate-800 border-slate-300";return e.jsx("span",{className:`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium ${C}`,children:m})}const ke=()=>{const{t:s}=X(),[n,x]=u.useState(""),[m,C]=u.useState("all"),[y,q]=u.useState(""),[i,b]=u.useState(null),{toast:p}=ve(),D=pe(),{user:N}=we(),h=N?._id?.toString(),{data:te,isLoading:se}=T({queryKey:["groups"],queryFn:async()=>(await j.get("/groups")).data.data}),v=te?.groups||[],{data:M,isLoading:ae}=T({enabled:v.length>0,queryKey:["all-groups-balances",v.map(t=>t._id).join(",")],refetchOnMount:!0,queryFn:async()=>{const t={};for(const a of v)try{const l=await j.get(`/settle/${a._id}/balances`);t[a._id]=l.data.data.balances||[]}catch{t[a._id]=[]}return t}});u.useEffect(()=>{!n&&v.length&&x(v[0]._id)},[v,n]);const{data:ne,isLoading:re}=T({enabled:!!n,queryKey:["groupSettlements",n],refetchOnMount:!0,queryFn:async()=>(await j.get(`/groups/${n}/settlements`)).data.data}),I=ne?.settlements||[],{data:le}=T({enabled:!!n,queryKey:["expenses",n],queryFn:async()=>(await j.get(`/expenses/${n}?limit=10&sortBy=createdAt&sortOrder=desc`)).data.data}),B=le?.expenses||[],oe=u.useMemo(()=>[["groupSettlements",n],["balances",n],["all-groups-balances"]],[n]),R=()=>{oe.forEach(t=>{D.invalidateQueries({queryKey:t}),D.refetchQueries({queryKey:t})})},z=u.useMemo(()=>{let t=0,a=0,l=0;return I.forEach(r=>{const o=r.rawStatus??r.status,d=r.payerId?.toString?.()||r.payerId,c=r.receiverId?.toString?.()||r.receiverId,f=parseFloat(r.remainingAmount)??0;if(parseFloat(r.totalAmount),o==="paid"||o==="accepted"){l+=1;return}d===h&&f>.01&&(t+=f),c===h&&f>.01&&(a+=f)}),{youOwe:t,youAreOwed:a,completedCount:l}},[I,h]),E=u.useMemo(()=>m==="all"?I:I.filter(t=>{const a=t.rawStatus??t.status,l=t.payerId?.toString?.()||t.payerId,r=t.receiverId?.toString?.()||t.receiverId,o=l===h,d=r===h,c=a==="paid"||a==="accepted";return m==="toPay"?o&&!c:m==="toReceive"?d&&!c:m==="completed"?c:!0}),[I,m,h]),G=u.useMemo(()=>{if(!y.trim())return E;const t=y.trim().toLowerCase();return E.filter(a=>{const l=(a.fromUserId?.username||"").toLowerCase(),r=(a.toUserId?.username||"").toLowerCase(),o=String(a.remainingAmount??a.totalAmount??"");return l.includes(t)||r.includes(t)||o.includes(t)})},[E,y]),ie=u.useMemo(()=>!n||!M?.[n]?!1:M[n].some(a=>Math.abs(parseFloat(a.balance||0))>.01),[n,M]),$=_({mutationFn:async({settlementId:t,amount:a})=>{const l=a!=null&&a>0?{amount:parseFloat(a)}:{};return(await j.post(`/settlements/${t}/pay`,l)).data},onSuccess:()=>{p({title:s("settle.paymentSettled"),description:s("settle.paymentSettledDesc")}),R()},onError:t=>{const a=t.response?.data?.message||t.message;p({variant:"destructive",title:s("settle.failedToSettlePayment"),description:a})}}),K=_({mutationFn:async t=>(await j.post(`/settlements/${t}/confirm`)).data,onSuccess:()=>{p({title:s("settle.settlementAccepted"),description:s("settle.settlementAcceptedDesc")}),R()},onError:t=>{const a=t.response?.data?.message||t.message;p({variant:"destructive",title:s("settle.failedToSettlePayment"),description:a})}}),Q=_({mutationFn:async t=>(await j.post(`/settlements/${t}/undo`)).data,onSuccess:()=>{p({title:s("settle.paymentRemoved"),description:s("settle.paymentRemovedDesc")}),R()},onError:t=>{const a=t.response?.data?.message||t.message;p({variant:"destructive",title:s("settle.failedToRemovePayment"),description:a})}}),O=_({mutationFn:async()=>(await j.post(`/groups/${n}/settlements/optimize`)).data,onSuccess:()=>{p({title:s("settle.optimizeSettlements"),description:s("settle.optimizeSettlementsDesc")}),R()},onError:t=>{p({variant:"destructive",title:s("settle.failedToSettlePayment"),description:t.response?.data?.message||t.message})}}),de=(t,a,l,r)=>{b({settlementId:t,amount:a,toName:l,remaining:r})},ce=()=>{i&&$.mutate({settlementId:i.settlementId,amount:i.amount},{onSettled:()=>b(null)})},me=t=>{K.mutate(t)},ue=t=>{Q.mutate(t)};return se||ae?e.jsx("div",{className:"flex items-center justify-center min-h-[320px]",children:e.jsx(J,{size:"lg"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsx(Pe,{open:!!i,onOpenChange:t=>!t&&b(null),children:e.jsxs(Ce,{className:"rounded-xl border border-border shadow-soft-lg",children:[e.jsxs(Ie,{children:[e.jsx(Ae,{children:s("settle.confirmPayment")}),e.jsx(Fe,{children:i?s("settle.confirmPaymentDesc",{amount:g(i.amount??i.remaining),name:i.toName}):""})]}),e.jsxs(De,{className:"gap-2 sm:gap-0",children:[e.jsx(P,{variant:"outline",onClick:()=>b(null),className:"rounded-xl",children:s("common.cancel")}),e.jsx(P,{className:"rounded-xl font-medium",onClick:ce,disabled:$.isPending,children:$.isPending?s("common.loading"):s("common.confirm")})]})]})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-primary to-purple-600 bg-clip-text text-transparent",children:s("settle.title")}),e.jsx("p",{className:"text-muted-foreground mt-1",children:s("settle.subtitle")})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(w,{className:"border-l-4 border-l-red-500 hover:shadow-lg transition-shadow",children:[e.jsxs(A,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:s("settle.youOweSummary","You owe")}),e.jsx(he,{className:"h-5 w-5 text-red-600"})]}),e.jsxs(S,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600",children:g(z.youOwe)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s("settle.totalAmountToPay")})]})]}),e.jsxs(w,{className:"border-l-4 border-l-green-500 hover:shadow-lg transition-shadow",children:[e.jsxs(A,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:s("settle.youAreOwedSummary","You are owed")}),e.jsx(ge,{className:"h-5 w-5 text-green-600"})]}),e.jsxs(S,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:g(z.youAreOwed)}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s("settle.totalAmountOwedToYou")})]})]}),e.jsxs(w,{className:"border-l-4 border-l-blue-500 hover:shadow-lg transition-shadow",children:[e.jsxs(A,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(F,{className:"text-sm font-medium",children:s("settle.completedSummary","Completed")}),e.jsx(V,{className:"h-5 w-5 text-blue-600"})]}),e.jsxs(S,{children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:z.completedCount}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s("settle.completedSettlements")})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(w,{className:"border-2 border-border/50 shadow-sm",children:[e.jsxs(A,{children:[e.jsxs(F,{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"h-5 w-5 text-primary"}),s("settle.yourGroups")]}),e.jsx(W,{children:s("settle.selectGroupToViewSettlements")})]}),e.jsx(S,{className:"p-0",children:e.jsx("div",{className:"space-y-1 p-3",children:v.map(t=>{const l=(M?.[t._id]||[]).find(d=>(d.userId?._id??d.userId)?.toString()===h),r=parseFloat(l?.balance||0),o=n===t._id;return e.jsxs("button",{type:"button",onClick:()=>x(t._id),className:`w-full text-left p-3 rounded-lg transition-all duration-200 flex items-center justify-between ${o?"bg-primary text-primary-foreground shadow-md":"bg-card border border-border/50 hover:border-primary/50 hover:bg-primary/5"}`,children:[e.jsx("span",{className:"font-medium text-sm truncate",children:t.title}),e.jsx("span",{className:`text-xs ml-2 ${o?"text-primary-foreground/80":"text-muted-foreground"}`,children:Math.abs(r)>.01?`${r<0?"-":"+"}${g(Math.abs(r))}`:s("settle.settled")}),e.jsx(fe,{className:`h-4 w-4 shrink-0 ${o?"text-primary-foreground":"text-muted-foreground"}`})]},t._id)})})})]})}),e.jsx("div",{className:"lg:col-span-3 space-y-4",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[ie&&e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>O.mutate(),disabled:O.isPending,className:"border-amber-500 text-amber-700 hover:bg-amber-50",children:[e.jsx(je,{className:"h-4 w-4 me-2"}),O.isPending?s("common.loading","Loading..."):s("settle.optimizeSettlements")]}),e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-xs",children:[e.jsx(ye,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(ee,{placeholder:s("settle.searchPlaceholder","Search by name or amount..."),value:y,onChange:t=>q(t.target.value),className:"pl-9 h-9"})]})]}),e.jsx("div",{className:"flex gap-1 border-b border-border",children:[{key:"all",label:s("settle.allTab","All")},{key:"toPay",label:s("settle.toPay")},{key:"toReceive",label:s("settle.toReceive")},{key:"completed",label:s("settle.completedSettlements")}].map(({key:t,label:a})=>e.jsx("button",{type:"button",onClick:()=>C(t),className:`px-3 py-2 text-sm font-medium rounded-t-md transition-colors ${m===t?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground hover:bg-muted/50"}`,children:a},t))})]}),re?e.jsx(w,{children:e.jsx(S,{className:"py-12 flex justify-center",children:e.jsx(J,{size:"lg"})})}):e.jsxs(w,{children:[e.jsxs(A,{children:[e.jsx(F,{children:s("settle.settlements")}),e.jsx(W,{children:"From → To, amount, status and actions"})]}),e.jsx(S,{className:"p-0 overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b bg-muted/50",children:[e.jsx("th",{className:"text-left font-medium p-3",children:"From"}),e.jsx("th",{className:"w-8 p-2","aria-hidden":!0}),e.jsx("th",{className:"text-left font-medium p-3",children:"To"}),e.jsx("th",{className:"text-right font-medium p-3",children:"Amount"}),e.jsx("th",{className:"text-center font-medium p-3",children:"Status"}),e.jsx("th",{className:"text-right font-medium p-3",children:"Action"})]})}),e.jsx("tbody",{children:G.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"p-8 text-center text-muted-foreground",children:m==="all"?s("settle.noSettlementsRecorded"):s("settle.noFilteredSettlements",{filter:m})})}):G.map(t=>{const a=t.id||t._id?.toString(),l=t.fromUserId?.username??t.payerId?.username??"—",r=t.toUserId?.username??t.receiverId?.username??"—",o=parseFloat(t.totalAmount)??0,d=parseFloat(t.remainingAmount)??Math.max(0,o-parseFloat(t.paidAmount||0)),c=t.rawStatus??t.status,f=t.status??"unpaid",U=c==="paid"||c==="accepted",xe=c==="awaiting_confirmation",Y=(t.payerId?.toString?.()||t.payerId)===h,H=(t.receiverId?.toString?.()||t.receiverId)===h;return e.jsxs("tr",{className:"border-b last:border-0 hover:bg-muted/30 transition-colors",children:[e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-medium shrink-0 ${L(l)}`,children:k(l)}),e.jsx("span",{className:"font-medium truncate max-w-[120px]",children:l})]})}),e.jsx("td",{className:"p-2 text-muted-foreground text-center",children:"→"}),e.jsx("td",{className:"p-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-medium shrink-0 ${L(r)}`,children:k(r)}),e.jsx("span",{className:"font-medium truncate max-w-[120px]",children:r})]})}),e.jsx("td",{className:"p-3 text-right font-semibold",children:g(U?o:d)}),e.jsx("td",{className:"p-3 text-center",children:e.jsx(Me,{rawStatus:c,status:f})}),e.jsx("td",{className:"p-3 text-right",children:U?e.jsxs("span",{className:"text-green-600 inline-flex items-center gap-1",children:[e.jsx(V,{className:"h-4 w-4"})," ✓"]}):xe&&H?e.jsx(P,{size:"sm",className:"bg-amber-600 hover:bg-amber-700 text-white",onClick:()=>me(a),disabled:K.isPending,children:s("settle.confirmReceived","Confirm Received")}):Y&&d>.01?e.jsx(Re,{settlementId:a,remaining:d,toName:r,onRequestPay:de,isPaying:$.isPending,t:s,formatMAD:g}):(c==="partial"||U)&&(Y||H)?e.jsxs(P,{size:"sm",variant:"outline",className:"text-muted-foreground hover:text-destructive hover:border-destructive",onClick:()=>ue(a),disabled:Q.isPending,title:s("settle.undoLastPayment"),children:[e.jsx(be,{className:"h-4 w-4 me-1"}),s("settle.removePayment")]}):e.jsx("span",{className:"text-muted-foreground text-xs",children:"—"})})]},a)})})]})})]}),n&&B.length>0&&e.jsxs("details",{className:"border rounded-lg bg-card",children:[e.jsxs("summary",{className:"px-4 py-3 cursor-pointer text-sm font-medium text-muted-foreground hover:text-foreground flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4"}),s("settle.groupExpenses","Group expenses")," — ",s("expenses.paidBy","Paid by")," & ",s("expenses.splitPreview","Split preview")]}),e.jsx("div",{className:"p-4 pt-0 space-y-3 border-t",children:B.slice(0,10).map(t=>{const a=t.payerId?.username??"—",l=parseFloat(t.amount)??0,r=t.splits||[];return e.jsxs("div",{className:"p-3 rounded-lg border bg-muted/20 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-2",children:[e.jsx("span",{className:"font-medium",children:t.description}),e.jsx("span",{className:"text-sm font-semibold",children:g(l)})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsxs("span",{children:[s("expenses.paidBy","Paid by"),":"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx("span",{className:`w-6 h-6 rounded-full flex items-center justify-center text-white text-xs font-medium ${L(a)}`,children:k(a)}),e.jsx("span",{className:"font-medium text-foreground",children:a})]})]}),r.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 pt-1",children:r.map(o=>{const d=o.userId?.username??"—",c=parseFloat(o.shareAmount)??0,f=l>0?c/l*100:0;return e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx("span",{className:`w-6 h-6 rounded-full flex items-center justify-center text-white font-medium shrink-0 ${L(d)}`,children:k(d)}),e.jsx("span",{className:"font-medium",children:d}),e.jsx("span",{className:"text-muted-foreground",children:g(c)}),e.jsx("div",{className:"w-12 h-1.5 rounded-full bg-muted overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full bg-primary",style:{width:`${Math.min(100,f)}%`}})})]},o.userId?._id??o.userId)})})]},t._id)})})]})]}):e.jsx(w,{children:e.jsxs(S,{className:"py-12 text-center",children:[e.jsx(Z,{className:"h-16 w-16 text-muted-foreground mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-semibold mb-2",children:s("settle.selectAGroup")}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s("settle.chooseGroupToViewSettlements")})]})})})]})]})};function Re({settlementId:s,remaining:n,toName:x,onRequestPay:m,isPaying:C,t:y,formatMAD:q}){const[i,b]=u.useState(""),p=()=>{m(s,null,x,n)},D=()=>{const N=parseFloat(i);N>0&&N<=n&&(m(s,N,x,n),b(""))};return e.jsxs("div",{className:"flex flex-wrap items-center justify-end gap-2",children:[e.jsx(ee,{type:"number",min:"0.01",step:"0.01",max:n,placeholder:q(n),value:i,onChange:N=>b(N.target.value),className:"w-24 h-8 text-xs rounded-lg"}),e.jsx(P,{size:"sm",variant:"outline",className:"rounded-lg",onClick:D,disabled:C||!i||parseFloat(i)<=0||parseFloat(i)>n,children:y("settle.payPart")}),e.jsx(P,{size:"sm",className:"rounded-lg font-medium bg-primary hover:bg-primary/90 text-primary-foreground",onClick:p,disabled:C||n<.01,children:y("settle.payAll")})]})}export{ke as default};
