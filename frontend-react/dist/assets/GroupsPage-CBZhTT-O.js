import{u as me,q as pe,r as l,v as xe,s as O,w as v,j as e,ao as Y,X as J,b as T,z as H,aE as W,aF as he,aG as ge,U as X,D as fe}from"./react-vendor--vquuSlV.js";import{u as je,h as ve,g as m,L as V,B as c,C as w,b as U,c as _,d as q,a as C,I as y,i as Z,j as ee}from"./index-CWe1EfRc.js";import{D as ye,a as Ne}from"./dialog-BKDal8hE.js";const Se=()=>{const{t:r}=me(),se=pe(),[d,re]=l.useState(""),[S,N]=l.useState(!1),[x,R]=l.useState(null),[n,b]=l.useState({title:"",description:"",type:"Friends",currency:"USD"}),[te,F]=l.useState(null),[h,A]=l.useState(""),[g,I]=l.useState([]),[p,z]=l.useState(""),{user:K}=je(),{toast:o}=ve(),u=xe(),{data:D,isLoading:ae,error:Q}=O({queryKey:["groups"],queryFn:async()=>{try{const s=await m.get("/groups"),t=s.data?.data||s.data;return{groups:Array.isArray(t?.groups)?t.groups.filter(a=>a&&a._id&&a.title):[],pagination:t?.pagination||{}}}catch(s){return console.error("Error fetching groups:",s),{groups:[],pagination:{}}}},refetchOnWindowFocus:!0,refetchOnMount:!0}),{data:ie}=O({queryKey:["friends"],queryFn:async()=>{const s=await m.get("/friends/my"),t=s.data?.data??s.data;return Array.isArray(t)?t:t&&Array.isArray(t.friends)?t.friends:t&&Array.isArray(t.data)?t.data:[]}}),f=ie??[],E=v({mutationFn:async()=>{const s=n.currency.toUpperCase().slice(0,3).padEnd(3,"U");if(s.length!==3)throw new Error("Currency must be exactly 3 characters (e.g., USD, EUR, MAD)");const t={title:n.title.trim(),description:n.description?.trim()||"",type:n.type||"Other",currency:s};return g.length>0&&(t.member_ids=g.map(a=>typeof a=="string"?a:a?.toString?.()||a)),(await m.post("/groups",t)).data},onSuccess:async s=>{o({title:r("notifications.success"),description:r("groups.groupCreated")}),j(),u.invalidateQueries({queryKey:["groups"]}),setTimeout(()=>{u.refetchQueries({queryKey:["groups"],exact:!1})},300)},onError:s=>{o({variant:"destructive",title:r("errors.serverError"),description:s.response?.data?.message||s.message})}}),G=v({mutationFn:async({id:s,data:t})=>(await m.put(`/groups/${s}`,t)).data,onSuccess:()=>{o({title:r("notifications.success")}),u.invalidateQueries({queryKey:["groups"]}),j()},onError:s=>{o({variant:"destructive",title:r("errors.serverError"),description:s.response?.data?.message||s.message})}}),ne=v({mutationFn:async s=>(await m.delete(`/groups/${s}`)).data,onSuccess:()=>{o({title:r("groups.groupDeleted")}),u.invalidateQueries({queryKey:["groups"]})},onError:s=>{o({variant:"destructive",title:r("groups.failedToDeleteGroup"),description:s.response?.data?.message||s.message})}}),$=v({mutationFn:async({groupId:s,userId:t})=>(await m.post(`/groups/${s}/members`,{userId:t})).data,onSuccess:()=>{o({title:r("groups.memberAdded"),description:r("groups.memberAddedDesc")}),u.invalidateQueries({queryKey:["groups"]}),u.refetchQueries({queryKey:["groups"],exact:!1}),F(null),A("")},onError:s=>{o({variant:"destructive",title:r("groups.failedToAddMember"),description:s.response?.data?.message||s.message})}});v({mutationFn:async({groupId:s,userId:t})=>(await m.delete(`/groups/${s}/members/${t}`)).data,onSuccess:()=>{o({title:r("groups.memberRemoved")}),u.invalidateQueries({queryKey:["groups"]}),u.invalidateQueries({queryKey:["group"]})},onError:s=>{o({variant:"destructive",title:r("groups.failedToRemoveMember"),description:s.response?.data?.message||s.message})}});const j=l.useCallback(()=>{b({title:"",description:"",type:"Friends",currency:"USD"}),I([]),z(""),N(!1),R(null)},[]),oe=s=>{se(`/groups/${s._id}/edit`)},le=()=>{if(!n.title||!n.title.trim()){o({variant:"destructive",title:r("errors.validationError"),description:r("groups.groupTitleRequired")});return}const s=n.currency.toUpperCase().trim();if(s.length!==3){o({variant:"destructive",title:r("errors.validationError"),description:r("groups.currencyMustBe3Chars")});return}x?G.mutate({id:x._id,data:{...n,currency:s}}):E.mutate()},ce=async s=>{if(!h||!h.trim()){o({variant:"destructive",title:r("errors.validationError"),description:r("groups.enterFriendEmailOrUsername")});return}const t=Array.isArray(f)?f.find(a=>{const M=a.email?.toLowerCase()||"",k=a.username?.toLowerCase()||"",P=h.toLowerCase().trim();return M===P||k===P}):null;if(!t){o({variant:"destructive",title:r("groups.friendNotFound"),description:r("groups.makeSureFriendFirstOnlyFriends")});return}const i=t._id||t.id||t.userId?._id||t.userId?.id;if(!i){o({variant:"destructive",title:r("common.error"),description:r("groups.couldNotFindFriendId")});return}$.mutate({groupId:s,userId:i})},B=l.useMemo(()=>{if(!p||!p.trim())return f;const s=p.toLowerCase().trim();return f.filter(t=>{const i=(t.username||"").toLowerCase(),a=(t.email||"").toLowerCase(),M=(t.firstName||"").toLowerCase(),k=(t.lastName||"").toLowerCase();return i.includes(s)||a.includes(s)||M.includes(s)||k.includes(s)})},[f,p]),de=l.useCallback(s=>{I(t=>t.includes(s)?t.filter(i=>i!==s):[...t,s])},[]),ue=l.useMemo(()=>{const t=(Array.isArray(D?.groups)?D.groups:[]).filter(a=>a&&a._id&&a.title);if(!d||d.trim()==="")return t;const i=d.toLowerCase().trim();return t.filter(a=>a.title?.toLowerCase().includes(i)||a.description?.toLowerCase().includes(i)||a.type?.toLowerCase().includes(i))},[D,d]);if(ae)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(V,{size:"lg"})});if(Q)return e.jsxs("div",{className:"text-center text-red-500",children:["Error loading groups: ",Q.message]});const L=ue||[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:r("groups.title")}),e.jsx("p",{className:"text-muted-foreground",children:r("groups.subtitle")})]}),e.jsxs(c,{onClick:()=>N(!S),children:[e.jsx(Y,{className:"me-2 h-4 w-4"}),r(S?"common.cancel":"groups.createGroup")]})]}),e.jsx(ye,{open:S,onOpenChange:s=>{N(s),s||(R(null),j())},children:e.jsx(Ne,{className:"max-w-2xl max-h-[90vh] overflow-y-auto p-0 gap-0",children:e.jsxs(w,{className:"border-0 shadow-none",children:[e.jsxs(U,{className:"flex flex-row items-center justify-between space-y-0 pb-4",children:[e.jsxs("div",{children:[e.jsx(_,{children:r(x?"groups.editGroup":"groups.createGroup")}),e.jsx(q,{children:r("groups.subtitle")})]}),e.jsx(c,{variant:"ghost",size:"icon",className:"h-8 w-8 shrink-0 rounded-full",onClick:j,"aria-label":"Close",children:e.jsx(J,{className:"h-4 w-4"})})]}),e.jsxs(C,{className:"space-y-4 pt-0",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium",children:[r("groups.groupTitle")," *"]}),e.jsx(y,{value:n.title,onChange:s=>b({...n,title:s.target.value}),placeholder:r("groups.groupTitle")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:r("groups.currency")}),e.jsxs("select",{value:n.currency,onChange:s=>b({...n,currency:s.target.value}),className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",children:[e.jsx("option",{value:"USD",children:"USD - US Dollar"}),e.jsx("option",{value:"EUR",children:"EUR - Euro"}),e.jsx("option",{value:"GBP",children:"GBP - British Pound"}),e.jsx("option",{value:"MAD",children:"MAD - Moroccan Dirham"}),e.jsx("option",{value:"CAD",children:"CAD - Canadian Dollar"}),e.jsx("option",{value:"AUD",children:"AUD - Australian Dollar"}),e.jsx("option",{value:"JPY",children:"JPY - Japanese Yen"}),e.jsx("option",{value:"CNY",children:"CNY - Chinese Yuan"}),e.jsx("option",{value:"INR",children:"INR - Indian Rupee"}),e.jsx("option",{value:"BRL",children:"BRL - Brazilian Real"})]})]}),e.jsxs("div",{className:"space-y-2 md:col-span-2",children:[e.jsx("label",{className:"text-sm font-medium",children:r("groups.description")}),e.jsx(y,{value:n.description,onChange:s=>b({...n,description:s.target.value}),placeholder:r("groups.description")})]})]}),!x&&e.jsxs("div",{className:"space-y-3 pt-4 border-t",children:[e.jsxs("label",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-4"}),r("groups.addFriendsToGroup")||"Add friends to this group"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:r("groups.selectFriendsToAdd")||"Search and select friends to add as members."}),e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute start-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(y,{placeholder:r("common.search")+" "+(r("groups.friends")||"friends")+"...",value:p,onChange:s=>z(s.target.value),className:"ps-10"})]}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 max-h-64 overflow-y-auto p-1",children:B.length>0?B.map(s=>{const t=s._id||s.id||s.userId?._id;if(!t)return null;const i=g.includes(t),a=s.username||s.firstName||s.email||"Friend";return e.jsxs("button",{type:"button",onClick:()=>de(t),className:`flex flex-col items-center gap-2 p-3 rounded-lg border-2 text-left transition-all hover:shadow-md ${i?"border-primary bg-primary/10 shadow-sm":"border-border hover:border-primary/50 bg-card"}`,children:[e.jsx("div",{className:`w-12 h-12 rounded-full flex items-center justify-center text-white font-semibold text-sm flex-shrink-0 ${ee(a)}`,children:Z(a)}),e.jsx("span",{className:"text-sm font-medium truncate w-full text-center",title:a,children:a}),e.jsx("span",{className:`flex items-center justify-center w-6 h-6 rounded-full border-2 text-xs ${i?"border-primary bg-primary text-primary-foreground":"border-muted-foreground"}`,children:i?e.jsx(W,{className:"h-3 w-3"}):null})]},t)}):e.jsx("div",{className:"col-span-full text-center py-6 text-muted-foreground text-sm",children:p?r("groups.noFriendsMatch")||"No friends match your search.":r("groups.addFriendsFirst")||"Add friends first from the Friends page to invite them here."})}),g.length>0&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:[g.length," ",r("groups.selected")||"selected"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(c,{onClick:le,disabled:!n.title||E.isLoading||G.isLoading,children:E.isLoading||G.isLoading?e.jsxs(e.Fragment,{children:[e.jsx(V,{size:"sm",className:"me-2"}),r("common.loading")]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"me-2 h-4 w-4"}),r(x?"common.save":"groups.createGroup")]})}),e.jsxs(c,{variant:"outline",onClick:j,children:[e.jsx(J,{className:"me-2 h-4 w-4"}),r("common.cancel")]})]})]})]})})}),e.jsxs(w,{children:[e.jsxs(U,{children:[e.jsx(_,{children:r("groups.title")}),e.jsx(q,{children:r("groups.groupsFound",{count:L.length})})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute start-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(y,{placeholder:r("common.search")+" "+r("groups.title").toLowerCase()+"...",value:d,onChange:s=>re(s.target.value),className:"ps-10"})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6",children:L.length>0?L.map(s=>e.jsxs(w,{className:"hover:shadow-lg transition-all duration-200 group border-2 hover:border-primary/50",children:[e.jsx(U,{className:"pb-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:`w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-lg flex-shrink-0 ${ee(s.title)}`,children:Z(s.title)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(_,{className:"text-lg font-semibold truncate",children:s.title}),e.jsx(q,{className:"text-xs line-clamp-2 mt-1",children:s.description||r("groups.noDescription")})]})]}),e.jsxs("div",{className:"flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0",children:[s.isAdmin&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>oe(s),title:r("groups.editGroup"),children:e.jsx(he,{className:"h-4 w-4"})}),(s.ownerId?._id?.toString()===K?._id?.toString()||s.ownerId?.toString()===K?._id?.toString())&&e.jsx(c,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:()=>{confirm(r("groups.deleteGroupConfirm"))&&ne.mutate(s._id)},title:r("groups.deleteGroup"),children:e.jsx(ge,{className:"h-4 w-4 text-red-500"})})]})]})}),e.jsxs(C,{className:"pt-0 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:s.memberCount||0}),e.jsx("span",{className:"text-muted-foreground text-xs",children:r("groups.members")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium",children:s.currency||"USD"})]})]}),e.jsxs("div",{className:"pt-2 border-t",children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:[e.jsx("span",{className:"font-medium",children:"Type:"})," ",s.type||"Other"]}),te===s._id?e.jsxs("div",{className:"space-y-2",children:[e.jsx(y,{placeholder:r("groups.friendEmailOrUsername"),value:h,onChange:t=>A(t.target.value),size:"sm",className:"h-8 text-xs"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(c,{size:"sm",className:"h-8 text-xs",onClick:()=>ce(s._id),disabled:!h||$.isLoading,children:[e.jsx(T,{className:"me-1 h-3 w-3"}),r("common.add")]}),e.jsx(c,{size:"sm",variant:"outline",className:"h-8 text-xs",onClick:()=>{F(null),A("")},children:r("common.cancel")})]})]}):e.jsxs(c,{size:"sm",variant:"outline",className:"w-full h-8 text-xs",onClick:()=>F(s._id),children:[e.jsx(T,{className:"me-2 h-3 w-3"}),r("groups.addMember")]})]})]})]},s._id)):e.jsx("div",{className:"col-span-full",children:e.jsx(w,{className:"border-dashed",children:e.jsx(C,{className:"text-center py-12",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(X,{className:"h-16 w-16 text-muted-foreground mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:r(d?"groups.noGroupsMatch":"groups.noGroupsFound")}),e.jsx("p",{className:"text-muted-foreground mb-6 text-sm",children:r(d?"groups.tryAdjustingSearch":"groups.createFirstGroupToStart")}),!d&&e.jsxs(c,{onClick:()=>N(!0),size:"lg",children:[e.jsx(Y,{className:"me-2 h-4 w-4"}),r("groups.createYourFirstGroup")]})]})})})})})]})]})]})};export{Se as default};
